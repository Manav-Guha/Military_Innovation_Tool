<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Military Innovation Assessment Framework — v3.8</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-presets="env,react"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js UMD -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    .big-tabs{display:flex;align-items:center;justify-content:center;gap:1rem;margin:1.25rem 0;width:100%}
    .big-tab{padding:.9rem 1.75rem;border-radius:1rem;font-weight:700;border:1px solid;transition:all .2s;flex-shrink:0}
    .big-tab-inactive{background:#f3f4f6;border-color:#d1d5db;color:#374151}
    .big-tab-inactive:hover{background:#e5e7eb}
    .big-tab-active{background:#fff;border-color:#2563eb;color:#1d4ed8;box-shadow:0 20px 25px -5px rgba(0,0,0,.15),0 8px 10px -6px rgba(0,0,0,.12)}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:1rem}
    .panel-h{padding:.9rem 1.25rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .panel-b{padding:1.1rem}
    .hint{font-size:.85rem;color:#6b7280}
    .item-row{padding:.7rem 0;border-bottom:1px solid #eef2f7}
    .item-row:last-child{border-bottom:none}
    .sub-item-row{padding:.5rem 0 .5rem 1rem;border-left:3px solid #e5e7eb;margin:.3rem 0}
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.375rem;font-size:.75rem;font-weight:700}
    .meter{height:.5rem;background:#e5e7eb;border-radius:.375rem;overflow:hidden}
    .meter-fill{height:100%;background:#2563eb}
    .interaction-indicator{background:#e0f2fe;border:1px solid #0288d1;color:#01579b;padding:.125rem .375rem;border-radius:.25rem;font-size:.7rem;margin-left:.5rem}
    .theoretical-note{background:#f0f9ff;border:1px solid #0ea5e9;color:#0c4a6e;padding:.75rem 1rem;border-radius:.5rem;font-size:.8rem;line-height:1.4}
    .c2-composite{background:#f8fafc;border:1px solid #cbd5e1;border-radius:.5rem;padding:.75rem;margin:.5rem 0}
    .c2-composite-header{background:#e2e8f0;border-bottom:1px solid #cbd5e1;padding:.5rem .75rem;font-weight:600;font-size:.8rem;color:#475569}

    /* Flag + tooltip */
    .flag{display:inline-flex;align-items:center;gap:.4rem;color:#7f1d1d;background:#fee2e2;border:1px dashed #7f1d1d;padding:.25rem .5rem;border-radius:.5rem;font-size:.75rem}
    .flag .dot{width:8px;height:8px;background:#ef4444;border-radius:999px}
    .tooltip{position:relative;display:inline-flex}

    /* Wide horizontal tooltip styled like criteria cards */
    .tooltip .tip{
      position:absolute;
      z-index:30;
      top:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%);
      visibility:hidden;
      opacity:0;
      transition:opacity .12s;

      background:#fef2f2;
      color:#7f1d1d;
      border:1px solid #fecaca;
      border-radius:.5rem;
      padding:.75rem 1rem;

      width:clamp(420px, 66vw, 900px) !important;
      max-width:90vw !important;
      white-space:normal !important;
      line-height:1.45;
      text-align:left;
      overflow-wrap:anywhere;
      box-shadow:0 8px 20px rgba(0,0,0,.25);
    }
    .tooltip:hover .tip,
    .tooltip:focus-within .tip{visibility:visible;opacity:1}

    /* Failed Criteria Cards */
    .criteria-card {background:#fef2f2;border:1px solid #fecaca;border-radius:0.5rem;padding:0.75rem 1rem;margin-top:0.75rem}
    .criteria-card-title {font-weight:700;color:#991b1b;margin-bottom:0.25rem}
    .criteria-card-text {font-size:0.9rem;color:#7f1d1d;line-height:1.4}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root" class="max-w-7xl mx-auto p-6"></div>

  <script type="text/babel">
    const {useState,useMemo,useEffect,useRef} = React;

    /* === Labels and helpers === */
    const LABELS = ["None", "Minimal", "Moderate", "Significant", "Transformative"];
    const getLabel = (value) => LABELS[Math.round(value)] || "None";

    const DIMS = [
      { key:"Cognitive",        label:"Cognitive",        def:"Doctrine, training, and mental models change to accommodate the novelty." },
      { key:"Irreversibility",  label:"Irreversibility",  def:"Prior doctrine ceases to be viable as decisive practice; no rational return." },
      { key:"Disruption",       label:"Disruption",       def:"Adversaries are compelled to abandon or radically alter existing methods." },
      { key:"Generative",       label:"Generative",       def:"The change enables new capabilities or follow-on innovations." }
    ];
    const ORDER = DIMS.map(d=>d.key);

    const SUB_KEYS = {
      Cognitive: ["c1","c2","c3","c4"],  // c2 is composite of c2a..c2d
      Irreversibility: ["i1","i2","i3","i4"],
      Disruption: ["d1","d2","d3","d4"],
      Generative: ["g1","g2","g3","g4"]
    };

    const mean = arr => {
      const vals = arr.map(v => +v || 0);
      return vals.reduce((a,v)=>a+v,0) / (vals.length || 1);
    };
    const indexScore = s => Math.round(25 * ORDER.reduce((a,k)=> a + (+s[k]||0), 0) / 4);
    /* === Historical dataset (27) === */
    const EXAMPLES = {
      "AI-Targeting": { scores: { Cognitive:1, Irreversibility:1, Disruption:1, Generative:2 }, justification: "AI-targeting speeds up existing processes; limited conceptual change.", sources: ["USAF Mad Scientist Initial Research"] },
      "AIP Submarine": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:2 }, justification: "Extended endurance; new patrol patterns.", sources: ["Polmar & Moore, 2004"] },
      "ASBM": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Conceptual innovation altering naval operational art through integrated OTH radar, SAR satellites, MRBMs, MIRV warheads.", sources: ["Erickson, 2013"] },
      "Barbed Wire": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Offensive assumptions untenable; defensive shift.", sources: ["Bull, 2013"] },
      "Blitzkrieg": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:4 }, justification: "Transformed land warfare; follow-ons; new strategy.", sources: ["Liddell Hart; Guderian"] },
      "Carrier Aviation": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Shift from battleships; aviation embedded.", sources: ["Friedman, 1983"] },
      "Cyber Warfare": { scores: { Cognitive:2, Irreversibility:2, Disruption:2, Generative:3 }, justification: "New domain; integration continues.", sources: ["Libicki, 2012"] },
      "Deep Battle/Reconnaissance Strike Complex": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:3 }, justification: "Operational art entrenched; frontal assaults untenable.", sources: ["Habeck, 2003"] },
      "F-16 Block D": { scores: { Cognitive:0, Irreversibility:1, Disruption:0, Generative:1 }, justification: "Modernization within air superiority paradigm.", sources: ["USAF Fact Sheets"] },
      "Hypersonics": { scores: { Cognitive:1, Irreversibility:1, Disruption:1, Generative:2 }, justification: "Acceleration; limited conceptual shift.", sources: ["Mahnken, 2007"] },
      "Information Warfare": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:4 }, justification: "Digital-age transformation of knowledge conflict.", sources: ["Ricks, 2012"] },
      "Lasers": { scores: { Cognitive:1, Irreversibility:1, Disruption:2, Generative:2 }, justification: "Capability improvement within paradigm.", sources: ["AFRL Primer, 2019"] },
      "Machine Gun": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:3 }, justification: "Linear tactics obsolete; irreversible organization.", sources: ["Ellis, 1975"] },
      "Military Robotics": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:3 }, justification: "Extends human capability; limited reconceptualization.", sources: ["Singer, 2009"] },
      "Minie Ball/Conoidal Bullet": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Napoleonic tactics untenable; assumptions questioned.", sources: ["Nosworthy, 2003"] },
      "Multi-Domain Battle Concept": { scores: { Cognitive:2, Irreversibility:1, Disruption:2, Generative:3 }, justification: "Challenges stovepipes; embedding incomplete.", sources: ["TRADOC 525-3-1"] },
      "Network-Centric Warfare": { scores: { Cognitive:1, Irreversibility:0, Disruption:1, Generative:2 }, justification: "Theory without institutional/doctrinal embedding; SoS implementations ≠ NCW.", sources: ["Alberts, Garstka, Stein, 1999"] },
      "Nuclear Weapons": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Complete transformation.", sources: ["Freedman, 2003"] },
      "PGMs": { scores: { Cognitive:1, Irreversibility:2, Disruption:2, Generative:3 }, justification: "Enables new targeting; paradigm intact.", sources: ["Hallion, 1995"] },
      "Radar": { scores: { Cognitive:2, Irreversibility:3, Disruption:3, Generative:3 }, justification: "Transforms air defense; organizational shifts.", sources: ["Fisher, 1988"] },
      "Stealth": { scores: { Cognitive:1, Irreversibility:2, Disruption:2, Generative:2 }, justification: "Improves capabilities within paradigm.", sources: ["Sweetman, 1986"] },
      "Stirrups": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Paradigmatic transformation; feudal structures.", sources: ["Lynn White Jr., 1962"] },
      "Stosstrupp Tactics": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:3 }, justification: "Infiltration doctrine; linear assaults obsolete.", sources: ["Gudmundsson, 1989"] },
      "T-72B3M Main Battle Tank": { scores: { Cognitive:0, Irreversibility:1, Disruption:0, Generative:1 }, justification: "Upgradation.", sources: ["Bartles, 2015"] },
      "Tank": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Transformed land warfare; org change; new thinking.", sources: ["Harris, 1995"] },
      "Telegraph": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Courier assumptions untenable; networked command.", sources: ["Hochfelder, 2012"] },
      "UAVs": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:3 }, justification: "Extends recon/strike; limited paradigm challenge.", sources: ["Singer, 2009"] }
    };

    /* === Scoring and interactions === */
    function aggregateC2(c2Scores) {
      return mean([c2Scores.c2a, c2Scores.c2b, c2Scores.c2c, c2Scores.c2d]);
    }

    function computeBaseFromSub(subVals){
      return {
        Cognitive:       mean([subVals.c1, aggregateC2(subVals), subVals.c3, subVals.c4]),
        Irreversibility: mean([subVals.i1, subVals.i2, subVals.i3, subVals.i4]),
        Disruption:      mean([subVals.d1, subVals.d2, subVals.d3, subVals.d4]),
        Generative:      mean([subVals.g1, subVals.g2, subVals.g3, subVals.g4])
      };
    }

    function aggregateWithContextualEffects(subVals) {
      const base = computeBaseFromSub(subVals);
      const meetsPrimary = base.Cognitive >= 3 && base.Irreversibility >= 3;
      let interactions = { disruptiveBoost: 0, contextualElevation: 0 };

      if (meetsPrimary) {
        interactions.disruptiveBoost =
          (base.Disruption >= 2 && base.Generative >= 2)
            ? Math.min(0.3, (base.Disruption + base.Generative - 4) * 0.1)
            : 0;
      } else {
        const synergy =
          (base.Disruption >= 2 && base.Generative >= 2)
            ? Math.min(0.5, (base.Disruption + base.Generative - 4) * 0.15)
            : 0;
        if (synergy > 0 && (base.Cognitive >= 2.5 || base.Irreversibility >= 2.5)) {
          interactions.contextualElevation = synergy * 0.6;
        }
        interactions.disruptiveBoost = synergy;
      }

      const enhanced = {
        Cognitive: Math.min(4, base.Cognitive + interactions.contextualElevation),
        Irreversibility: Math.min(4, base.Irreversibility + interactions.contextualElevation),
        Disruption: Math.min(4, base.Disruption + interactions.disruptiveBoost),
        Generative: Math.min(4, base.Generative + interactions.disruptiveBoost)
      };
      enhanced._base = base;
      enhanced._interactions = interactions;
      enhanced._meetsPrimaryThreshold = meetsPrimary;
      enhanced._contextuallyRevealed = !meetsPrimary && enhanced.Cognitive >= 3 && enhanced.Irreversibility >= 3;
      enhanced._hasInteractions = Object.values(interactions).some(v => v > 0);
      return enhanced;
    }

    function classify(dimScores, isHistorical=false) {
      const vals = ORDER.map(k => +(dimScores[k]||0));
      if (isHistorical) {
        const c=dimScores.Cognitive||0, i=dimScores.Irreversibility||0;
        if (c>=3 && i>=3) {
          const strong=vals.filter(v=>v>=3).length;
          if (strong===4) return "Transformative Innovation";
          if (strong>=3) return "Revolutionary Innovation";
          return "Innovation";
        }
        return vals.some(v=>v>=2) ? "Modernization" : "Upgradation";
      } else {
        const meets=(dimScores.Cognitive||0)>=3 && (dimScores.Irreversibility||0)>=3;
        if (meets) {
          const strong=vals.filter(v=>v>=3).length;
          if (strong===4) return "Transformative Innovation";
          if (strong>=3) return "Revolutionary Innovation";
          return "Innovation";
        }
        return vals.some(v=>v>=2) ? "Modernization" : "Upgradation";
      }
    }

    /* === Criteria checks and violations === */
    const violationMessages = {
      incomplete: "All sliders must be rated before analysis.",
      coherence: "High Disruption/Generative but weak Cognitive/Irreversibility. Suggests disruptive claims without doctrinal change. Re-examine assumptions.",
      imbalance: "Extreme imbalance across dimensions (>3 points spread). Suggests tunnel vision.",
      indexStrength: "Index below 40. Overall balance too weak to sustain innovation.",
      contextInvalid: "Contextual recognition requires all base dimensions ≥2.",
      overElevation: "Contextual elevation cannot compensate for collapsed bases.",
      overflow: "Computed score exceeded 0–4 ceiling after elevation."
    };

    function computeViolations(subs, enhanced, isHistorical){
      if (isHistorical) return {};
      const base = enhanced._base;
      const arr = [base.Cognitive, base.Irreversibility, base.Disruption, base.Generative];
      return {
        incomplete: Object.values(subs).some(v => v == null || isNaN(+v)),
        coherence: (base.Disruption>=3 || base.Generative>=3) && (base.Cognitive<2 || base.Irreversibility<2),
        imbalance: Math.max(...arr) - Math.min(...arr) > 3,
        indexStrength: indexScore(enhanced) < 40,
        contextInvalid: (enhanced._interactions.contextualElevation>0) && !(arr.every(v=>v>=2)),
        overElevation: (enhanced._interactions.contextualElevation>0.6) && !(arr.every(v=>v>=2)),
        overflow: [enhanced.Cognitive,enhanced.Irreversibility,enhanced.Disruption,enhanced.Generative].some(v=>v>4)
      };
    }
    /* === Criteria badge (uses wide red tooltip) === */
    function CriteriaBadge({violations, isHistorical}){
      if (isHistorical) {
        return <span className="badge bg-green-100 text-green-800">Historical case (criteria checks not applied)</span>;
      }
      const active = Object.entries(violations).filter(([_,v])=>v);
      if (active.length===0){
        return <span className="badge bg-green-100 text-green-800">Criteria satisfied — analysis allowed</span>;
      }
      const msg = active.map(([k])=>"• "+(violationMessages[k]||k)).join("\n");
      return (
        <span className="tooltip">
          <span className="flag"><span className="dot"></span><span>Blocked: criteria not met</span></span>
          <span className="tip">{msg}</span>
        </span>
      );
    }

    /* === Feedback + analysis generation === */
    function generateUserFeedback(subScores, dimScores, classification) {
      const feedback = [];
      const labelFor = (v)=>getLabel(v).toLowerCase();

      ORDER.forEach(dim => {
        const d = DIMS.find(x=>x.key===dim);
        const val = dimScores[dim] || 0;
        if (dim==='Cognitive') {
          const c2 = aggregateC2(subScores);
          feedback.push(`**${d.label}**: C1 ${labelFor(subScores.c1||0)}, C2 ${labelFor(c2)}, C3 ${labelFor(subScores.c3||0)}, C4 ${labelFor(subScores.c4||0)}. Total: ${labelFor(val)} (${Math.round(val*10)/10}/4).`);
        } else {
          feedback.push(`**${d.label}**: total ${labelFor(val)} (${Math.round(val*10)/10}/4).`);
        }
      });

      if (dimScores._meetsPrimaryThreshold) {
        feedback.push(`**Primary Threshold Recognition**: Cognitive ≥ 3 and Irreversibility ≥ 3 satisfied.`);
      } else if (dimScores._contextuallyRevealed) {
        feedback.push(`**Contextual Framework Recognition**: Below-threshold base was elevated through Disruption–Generative synergy.`);
      } else {
        feedback.push(`**Below Recognition Criteria**: Neither primary nor contextual criteria met.`);
      }

      if (dimScores._hasInteractions) {
        const ce = dimScores._interactions?.contextualElevation || 0;
        const db = dimScores._interactions?.disruptiveBoost || 0;
        feedback.push(`**Interactive Effects**: contextual +${ce.toFixed(2)} to Cognitive/Irreversibility; disruptive +${db.toFixed(2)} to Disruption/Generative.`);
      }

      const total = ORDER.reduce((s,k)=> s + (dimScores[k]||0), 0);
      feedback.push(`**Final Classification**: ${classification} (total ${Math.round(total*10)/10}/16, index ${indexScore(dimScores)}).`);
      return feedback;
    }

    function getEducationalAnalysis(caseName, example) {
      const s = example.scores;
      return [
        `**Historical Analysis**: Scored Cognitive:${s.Cognitive}, Irreversibility:${s.Irreversibility}, Disruption:${s.Disruption}, Generative:${s.Generative}.`,
        `**Classification**: ${classify(s, true)}.`,
        `**Justification**: ${example.justification}`,
        `**Sources**: ${example.sources.join(', ')}.`
      ];
    }

    /* === Modal === */
    function IssuesModal({issues,meta,subScores,dimScores,onClose}){
      if(!issues && !meta) return null;
      const isHistorical = !!(meta && meta.ex && EXAMPLES[meta.label]);
      const isUserInput = !isHistorical && meta && meta.label && Object.values(subScores||{}).some(v => v>0);

      let title='Assessment Review', sub='Assessment completed successfully.', content=[];
      if (isUserInput) {
        title='Your Innovation Assessment';
        sub = `Analysis of your innovation concept: "${meta.label}"`;
        content = generateUserFeedback(subScores, dimScores, classify(dimScores,false));
      } else if (isHistorical) {
        title='Historical Case Analysis';
        sub = `Educational analysis of ${meta.label}:`;
        content = getEducationalAnalysis(meta.label, meta.ex);
      } else {
        content = ["Assessment completed successfully."];
      }

      return (
        <div className="modal-bg" onClick={onClose}>
          <div className="modal" onClick={e=>e.stopPropagation()}>
            <div className="modal-h bg-blue-50">{title}</div>
            <div className="px-4 pt-2 pb-1 text-sm text-gray-700">{sub}</div>
            <div className="p-4 max-h-[60vh] overflow-auto">
              <ul className="space-y-4">
                {content.map((m,i)=>(
                  <li key={i} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                    <span className="text-blue-600 font-bold text-lg">•</span>
                    <div className="text-sm text-gray-800 leading-relaxed"
                      dangerouslySetInnerHTML={{__html: m.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>')}}/>
                  </li>
                ))}
              </ul>
            </div>
            <div className="p-4 border-t text-right">
              <button onClick={onClose} className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">OK</button>
            </div>
          </div>
        </div>
      );
    }

    /* === Sub-indicator schema === */
    const SUBS = {
      Cognitive: [
        {k:"c1", name:"Core Assumptions Challenged", hint:"Prospective vs retrospective change"},
        {k:"c2", name:"Shift in Process Logics/Systems", hint:"Composite of procedures, architecture, interface, skills", composite:true,
          subElements:[
            {k:"c2a",name:"Procedural Integration",hint:"SOP changes?"},
            {k:"c2b",name:"System Architecture",hint:"Infrastructure/API shifts?"},
            {k:"c2c",name:"Human-Machine Interface",hint:"Cognitive workflow shifts?"},
            {k:"c2d",name:"Skill Requirements",hint:"New competencies?"},
          ]
        },
        {k:"c3", name:"Doctrine/PME Revision", hint:"TTPs, manuals, curricula"},
        {k:"c4", name:"New Criteria for Success", hint:"Measures of effectiveness"},
      ],
      Irreversibility: [
        {k:"i1", name:"Training & Skill Path Dependence", hint:"Pipelines"},
        {k:"i2", name:"Logistics & Infrastructure", hint:"Supply/maintenance"},
        {k:"i3", name:"Adversary Compulsion to Mirror", hint:"Rival adoption"},
        {k:"i4", name:"Institutional Lock-in/Force Structure", hint:"Sunk costs"},
      ],
      Disruption: [
        {k:"d1", name:"OODA Disruption", hint:"Observation/decision broken"},
        {k:"d2", name:"Doctrinal Breakpoints", hint:"Old doctrine unusable"},
        {k:"d3", name:"Kill-Chain/Topology Shifts", hint:"Sequencing changes"},
        {k:"d4", name:"Adversary Scramble", hint:"Urgent counters"},
      ],
      Generative: [
        {k:"g1", name:"New Capability Families", hint:"Follow-ons"},
        {k:"g2", name:"Cross-Domain Spillovers", hint:"Transfers"},
        {k:"g3", name:"Organizational Implications", hint:"Formations/schools"},
        {k:"g4", name:"Conceptual Platform", hint:"Base for further development"},
      ]
    };

    /* === Sub-panel component === */
    function SubPanel({dim, values, setValue, locked=false, showInteractions=false, isHistorical=false}) {
      const items = SUBS[dim];
      const rated = items.filter(it => (values[it.k]||0) > 0).length;

      let baseScore;
      if (dim === 'Cognitive') {
        baseScore = mean([values.c1||0, aggregateC2(values), values.c3||0, values.c4||0]);
      } else {
        baseScore = mean(items.map(it => values[it.k]||0));
      }

      let displayScore = baseScore;
      let hasBoost = false;
      if (showInteractions && !isHistorical) {
        const enhanced = aggregateWithContextualEffects(values);
        displayScore = enhanced[dim];
        hasBoost = Math.abs(displayScore - baseScore) > 0.05;
      }

      const dMeta = DIMS.find(d=>d.key===dim);

      return (
        <div className="panel">
          <div className="panel-h">
            <div className="flex items-center gap-2">
              <span>{dMeta.label}</span>
              {hasBoost && (
                <span className="interaction-indicator" title="Score enhanced by contextual interactions">
                  +{Math.round((displayScore - baseScore)*100)/100}
                </span>
              )}
            </div>
            <div className="hint">{dMeta.def}</div>
            <div className="text-sm text-gray-600 mt-1">
              {isHistorical ? `Historical case assessment` : `${rated}/4 rated`} • Score: {getLabel(displayScore)} ({Math.round(displayScore*10)/10})
              {hasBoost && <span className="text-xs text-blue-600 ml-1">(base: {Math.round(baseScore*10)/10})</span>}
            </div>
          </div>
          <div className="panel-b">
            {items.map(it=>(
              <div key={it.k} className={it.composite ? "c2-composite" : "item-row"}>
                <div className="flex items-center justify-between">
                  <div className="font-medium text-sm"><span>{it.name}</span></div>
                  <div className="text-xs text-gray-600">
                    {it.composite ? getLabel(aggregateC2(values)) : getLabel(values[it.k]||0)}
                  </div>
                </div>
                <div className="hint">{it.hint}</div>

                {it.composite && it.subElements && (
                  <div className="ml-4 space-y-2 border-l-2 border-gray-200 pl-3 mt-3">
                    <div className="c2-composite-header">
                      C2 Composite Sub-Elements (Average: {getLabel(aggregateC2(values))} - {Math.round(aggregateC2(values)*10)/10}/4)
                    </div>
                    {it.subElements.map(subEl => (
                      <div key={subEl.k} className="sub-item-row">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <label className="block text-xs font-medium text-gray-600">{subEl.name}</label>
                            <div className="text-xs text-gray-500 mt-1">{subEl.hint}</div>
                          </div>
                          <div className="ml-3 text-xs text-gray-600">{getLabel(values[subEl.k]||0)}</div>
                        </div>
                        {locked ? (
                          <>
                            <div className="mt-2 meter"><div className="meter-fill" style={{width: `${((values[subEl.k]||0)/4)*100}%`}}></div></div>
                            <div className="text-[10px] text-gray-500 mt-1">Locked from historical case</div>
                          </>
                        ) : (
                          <div className="mt-3">
                            <input type="range" min="0" max="4" step="1" value={values[subEl.k]||0}
                              onChange={e=> setValue(subEl.k, Number(e.target.value))}
                              className="w-full"/>
                            <div className="flex justify-between text-xs text-gray-500 mt-1">
                              {LABELS.map((label, idx) => (
                                <span key={idx} className={values[subEl.k] === idx ? 'font-bold text-blue-600' : ''}>{label}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {!it.composite && (
                  <>
                    {locked ? (
                      <>
                        <div className="mt-2 meter"><div className="meter-fill" style={{width: `${((values[it.k]||0)/4)*100}%`}}></div></div>
                        <div className="text-[10px] text-gray-500 mt-1">Locked from historical case</div>
                      </>
                    ) : (
                      <div className="mt-3">
                        <input type="range" min="0" max="4" step="1" value={values[it.k]||0}
                          onChange={e=> setValue(it.k, Number(e.target.value))}
                          className="w-full"/>
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          {LABELS.map((label, idx) => (
                            <span key={idx} className={values[it.k] === idx ? 'font-bold text-blue-600' : ''}>{label}</span>
                          ))}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* === Charts === */
    function RadarChart({scores}) {
      const ref = useRef(null);
      const chart = useRef(null);
      const values = useMemo(() => ORDER.map(k => +scores[k] || 0), [scores]);

      useEffect(() => {
        const ctx = ref.current.getContext('2d');
        if (chart.current) chart.current.destroy();
        chart.current = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: DIMS.map(d => d.label),
            datasets: [
              {
                label: 'Current Assessment',
                data: values,
                fill: true,
                backgroundColor: 'rgba(37,99,235,0.2)',
                borderColor: 'rgba(37,99,235,1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: 'rgba(37,99,235,1)'
              },
              {
                label: 'Primary Recognition Threshold (Cognitive ≥ 3, Irreversibility ≥ 3)',
                data: [3,3,0,0],
                fill: false,
                borderColor: 'rgba(239,68,68,0.8)',
                borderDash: [6, 4],
                borderWidth: 2,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.r;
                    const qualitative = getLabel(value);
                    return `${label}: ${qualitative} (${Math.round(value*10)/10})`;
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                min: 0,
                max: 4,
                ticks: { 
                  stepSize: 1,
                  callback: value => getLabel(value)
                },
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
        return () => { if (chart.current) chart.current.destroy(); };
      }, [values]);

      return <div style={{height:"400px"}}><canvas ref={ref}/></div>;
    }

    function BarChart({scores}){
      const ref=useRef(null), chart=useRef(null);
      const values = useMemo(()=> ORDER.map(k => +scores[k]||0), [scores]);
      const colorFor=v=> v>=3?'rgba(22,163,74,0.85)':v>=2?'rgba(234,179,8,0.95)':'rgba(239,68,68,0.95)';
      
      useEffect(()=>{
        const ctx=ref.current.getContext('2d');
        if(chart.current) chart.current.destroy();
        chart.current=new Chart(ctx,{
          type:'bar',
          data:{
            labels:DIMS.map(d=>d.label),
            datasets:[{
              label:'Dimension Scores',
              data:values,
              backgroundColor:values.map(colorFor),
              borderColor:values.map(colorFor),
              borderWidth: 1
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{display:false},
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.y;
                    const qualitative = getLabel(value);
                    return `${qualitative} (${Math.round(value*10)/10})`;
                  }
                }
              }
            },
            scales:{
              y:{
                beginAtZero:true,
                min:0,
                max:4,
                ticks:{
                  stepSize:1,
                  callback: value => getLabel(value)
                },
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: { grid: { display: false } }
            }
          }
        });
        return ()=> chart.current && chart.current.destroy();
      },[values]);
      return <div style={{height:"400px"}}><canvas ref={ref}/></div>;
    }

    /* === Historical Examples === */
    function HistoricalExamples({setScores,setMeta,setSubScores,setIssues}){
      const keys=Object.keys(EXAMPLES);
      const [sel,setSel]=useState("");
      const [subs,setSubs]=useState(null);

      function buildSubFromExample(ex) {
        const s = {};
        const rep=(arr,val)=>arr.forEach(k=>s[k]=val);
        rep(SUB_KEYS.Disruption,      ex.scores.Disruption);
        rep(SUB_KEYS.Irreversibility, ex.scores.Irreversibility);
        rep(SUB_KEYS.Cognitive,       ex.scores.Cognitive);
        rep(SUB_KEYS.Generative,      ex.scores.Generative);
        s.c2a = ex.scores.Cognitive; s.c2b = ex.scores.Cognitive;
        s.c2c = ex.scores.Cognitive; s.c2d = ex.scores.Cognitive;
        return s;
      }

      function evaluateAndRender(nextSubs){
        const enhanced = aggregateWithContextualEffects(nextSubs);
        enhanced._isHistoricalExample = true;  // criteria not applied
        setScores(enhanced);
        setSubScores(nextSubs);
        const ex = EXAMPLES[sel];
        setIssues(getEducationalAnalysis(sel, ex));
      }

      function setValue(k,v){
        setSubs(prev=>{
          const next = {...prev, [k]: v};
          evaluateAndRender(next);
          return next;
        });
      }

      function loadFromSelection(v){
        setSel(v);
        if (!v) {
          setScores({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0});
          setMeta({});
          setSubScores({});
          setIssues([]);
          return;
        }
        const ex = EXAMPLES[v];
        setMeta({label: v, ex});
        const subVals = buildSubFromExample(ex);
        setSubs(subVals);
        evaluateAndRender(subVals);
      }

      const ex = sel ? EXAMPLES[sel] : null;

      return (
        <div className="space-y-6">
          <div>
            <h2 className="text-2xl font-semibold">Historical Examples</h2>
            <p className="text-sm text-gray-600 mt-1">
              Select a case. Sliders can be adjusted to explore counterfactuals. Historical cases show results without criteria checks.
            </p>
          </div>

          <div className="flex flex-wrap items-center gap-3">
            <label className="text-sm font-medium">Example</label>
            <select value={sel} onChange={e=>loadFromSelection(e.target.value)} className="border rounded-md px-3 py-2 text-sm min-w-[20rem]">
              <option value="">— choose a case —</option>
              {keys.map(k=><option key={k} value={k}>{k}</option>)}
            </select>
          </div>

          {ex && (
            <div className="grid md:grid-cols-2 gap-6">
              {ORDER.map(dim=>{
                const pick = {};
                SUB_KEYS[dim].forEach(key => pick[key] = (subs && key in subs) ? subs[key] : ex.scores[dim]||0);
                if (dim === 'Cognitive') {
                  ['c2a','c2b','c2c','c2d'].forEach(k => pick[k] = (subs && k in subs) ? subs[k] : ex.scores.Cognitive||0);
                }
                return <SubPanel key={dim} dim={dim} values={pick} setValue={setValue} locked={false} showInteractions={false} isHistorical={true} />;
              })}
              <div className="md:col-span-2 panel panel-b text-sm">
                <div className="font-semibold mb-1">Explanation & References</div>
                <div className="text-gray-700 mb-3">{ex.justification}</div>
                {(ex.sources||[]).map((r,i)=>(<div key={i}>• {r}</div>))}
              </div>
            </div>
          )}
        </div>
      );
    }

    /* === Test Your Idea === */
    function TestYourIdea({setScores,setMeta,setSubScores,setIssues}){
      const [label,setLabel]=useState("");
      const [sub,setSub]=useState({
        d1:0,d2:0,d3:0,d4:0,
        i1:0,i2:0,i3:0,i4:0,
        c1:0,c2:0,c3:0,c4:0,c2a:0,c2b:0,c2c:0,c2d:0,
        g1:0,g2:0,g3:0,g4:0
      });

      function runEval(nextSub){
        const enhanced = aggregateWithContextualEffects(nextSub);
        setScores(enhanced);
        setSubScores(nextSub);
        setIssues(generateUserFeedback(nextSub, enhanced, classify(enhanced,false)));
      }

      function setValue(k,v){
        setSub(prev=>{
          const next = {...prev, [k]: v};
          runEval(next);
          return next;
        });
      }

      useEffect(()=>{ setMeta({label}); },[label]);

      return (
        <div className="space-y-6">
          <div className="theoretical-note">
            <div className="font-semibold mb-2">Recognition Framework</div>
            <div className="space-y-1 text-sm">
              <div><strong>Primary Threshold:</strong> Cognitive ≥ 3 AND Irreversibility ≥ 3</div>
              <div><strong>Contextual Framework:</strong> Disruption–Generative synergy can elevate borderline Cognitive/Irreversibility</div>
              <div><strong>C2:</strong> composite of procedures, architecture, interface, skills</div>
            </div>
          </div>

          <div className="panel panel-b">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 className="text-2xl font-semibold">Test Your Idea</h2>
                <p className="text-sm text-gray-600 mt-2">Use sliders to score manifestation across sub-indicators.</p>
              </div>
              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">Innovation Concept Title</label>
                <input value={label} onChange={e=>setLabel(e.target.value)}
                       className="case-title-input w-80" 
                       placeholder="e.g., AI-enabled autonomous logistics coordination"/>
                {!label && <div className="text-xs text-blue-600">Enter a descriptive title</div>}
              </div>
            </div>

            <div className="mt-6 grid md:grid-cols-2 gap-6">
              {ORDER.map(dim=>{
                const pick = {};
                SUB_KEYS[dim].forEach(key => pick[key] = sub[key]);
                if (dim === 'Cognitive') ['c2a','c2b','c2c','c2d'].forEach(k => pick[k] = sub[k]);
                return <SubPanel key={dim} dim={dim} values={pick} setValue={setValue} locked={false} showInteractions={true} />;
              })}
            </div>
          </div>
        </div>
      );
    }

    /* === Charts + Status (classification, badges, failed criteria cards) === */
    function ChartsPanel({scores,meta,subScores,openModal}){
      const isHistorical = !!(meta && meta.ex && EXAMPLES[meta.label]);

      const violations = useMemo(()=>{
        if (!subScores || Object.keys(subScores).length===0) return {};
        return computeViolations(subScores, scores, isHistorical);
      },[subScores, scores, isHistorical]);

      const disabled = !isHistorical && Object.values(violations).some(Boolean);
      const meetsPrimaryThreshold = scores._meetsPrimaryThreshold;
      const contextuallyRevealed = scores._contextuallyRevealed;
      const idx = indexScore(scores);
      const cls = classify(scores, isHistorical);

      const failedKeys = Object.entries(violations).filter(([_,v])=>v).map(([k])=>k);

      return (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="panel">
            <div className="panel-h">Radar Chart</div>
            <div className="panel-b"><RadarChart scores={scores}/></div>
          </div>
          <div className="panel">
            <div className="panel-h">Bar Chart (Qualitative Scale)</div>
            <div className="panel-b"><BarChart scores={scores}/></div>
          </div>

          <div className="md:col-span-2 panel panel-b text-sm">
            <div className="flex flex-wrap items-center gap-4">
              <div><span className="font-semibold">Index:</span> {Number.isFinite(idx)?idx:"—"}</div>
              <div>
                <span className="font-semibold">
                  Classification result = {cls}{disabled ? " (but criteria checks block further analysis)" : ""}
                </span>
              </div>
              <div>
                {meetsPrimaryThreshold ? 
                  <span className="badge bg-green-100 text-green-800">Primary Threshold Recognition</span> :
                  contextuallyRevealed ?
                  <span className="badge bg-blue-100 text-blue-800">Contextual Framework Recognition</span> :
                  <span className="badge bg-yellow-100 text-yellow-800">Below Recognition Criteria</span>
                }
              </div>

              <CriteriaBadge violations={violations} isHistorical={isHistorical}/>

              {meta && meta.label ? <div className="text-gray-600">Case: <span className="font-medium">{meta.label}</span></div> : null}

              <button
                onClick={()=>{ if(!disabled) openModal(); }}
                disabled={disabled}
                className={`ml-auto px-4 py-2 rounded-md ${disabled?'bg-gray-300 text-gray-600 cursor-not-allowed':'bg-blue-600 text-white hover:bg-blue-700'}`}>
                View Analysis
              </button>
            </div>

            {failedKeys.length>0 && (
              <div className="mt-3">
                <div className="font-semibold text-red-700">Failed Criteria:</div>
                {failedKeys.map(k=>(
                  <div key={k} className="criteria-card">
                    <div className="criteria-card-title">Failed Criterion — {k==='indexStrength'?'Index Strength':k[0].toUpperCase()+k.slice(1)}</div>
                    <div className="criteria-card-text">{violationMessages[k]}</div>
                  </div>
                ))}
              </div>
            )}

            <div className="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
              {DIMS.map(d=>(
                <div key={d.key} className="text-sm">
                  <span className="font-semibold">{d.label}:</span> {getLabel(scores[d.key] || 0)} ({Math.round((scores[d.key] || 0)*10)/10})
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* === App === */
    function App(){
      const [tab,setTab]=useState('test');
      const [scores,setScores]=useState({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0,_base:{Cognitive:0,Irreversibility:0,Disruption:0,Generative:0}});
      const [meta,setMeta]=useState({label:""});
      const [subScores,setSubScores]=useState({});
      const [issues,setIssues]=useState([]);
      const [modalOpen,setModalOpen]=useState(false);

      return (
        <main>
          <header className="text-center space-y-1 mb-6">
            <h1 className="text-4xl md:text-5xl font-extrabold text-gray-900">Military Innovation Assessment Framework</h1>
            <h2 className="text-xl md:text-2xl font-bold text-gray-800">A Four-Dimensional Recognition Tool</h2>
            <div className="text-md md:text-lg text-gray-700">Based on "Military Innovation: Between the Knowns and the Unknowns"</div>
            <div className="text-xs text-gray-500 mt-1">(c) Manabrata Guha, 2025</div>
          </header>

          <div className="big-tabs">
            {[
              {k:'test',label:'Test Your Idea'},
              {k:'examples',label:'Historical Examples'}
            ].map(t=>(
              <button key={t.k} onClick={()=>setTab(t.k)}
                className={'big-tab ' + (tab===t.k?'big-tab-active':'big-tab-inactive')}>{t.label}</button>
            ))}
          </div>

          <section className="space-y-6">
            {tab==='test' && (
              <>
                <TestYourIdea
                  setScores={setScores}
                  setMeta={setMeta}
                  setSubScores={setSubScores}
                  setIssues={setIssues}
                />
                <ChartsPanel scores={scores} meta={meta} subScores={subScores} openModal={()=>setModalOpen(true)}/>
              </>
            )}
            {tab==='examples' && (
              <>
                <HistoricalExamples
                  setScores={setScores}
                  setMeta={setMeta}
                  setSubScores={setSubScores}
                  setIssues={setIssues}
                />
                <ChartsPanel scores={scores} meta={meta} subScores={subScores} openModal={()=>setModalOpen(true)}/>
              </>
            )}
          </section>

          <footer className="mt-10 text-center text-xs text-gray-500">
            Military Innovation Assessment Framework v3.8 (c) Manabrata Guha, 2025
          </footer>

          {modalOpen && <IssuesModal issues={issues} meta={meta} subScores={subScores} dimScores={scores} onClose={()=>setModalOpen(false)}/>}
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
