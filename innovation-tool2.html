<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Military Innovation Assessment Framework ‚Äì v5.1</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-presets="env,react"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js UMD -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    .big-tabs{display:flex;align-items:center;justify-content:center;gap:1rem;margin:1.25rem 0;width:100%;flex-wrap:wrap}
    .big-tab{padding:.9rem 1.75rem;border-radius:1rem;font-weight:700;border:1px solid;transition:all .2s;flex-shrink:0}
    .big-tab-inactive{background:#f3f4f6;border-color:#d1d5db;color:#374151}
    .big-tab-inactive:hover{background:#e5e7eb}
    .big-tab-active{background:#fff;border-color:#2563eb;color:#1d4ed8;box-shadow:0 20px 25px -5px rgba(0,0,0,.15),0 8px 10px -6px rgba(0,0,0,.12)}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:1rem}
    .panel-h{padding:.9rem 1.25rem;border-bottom:1px solid #e5e7eb;font-weight:700}
    .panel-b{padding:1.1rem}
    .hint{font-size:.85rem;color:#6b7280}
    .item-row{padding:.7rem 0;border-bottom:1px solid #eef2f7}
    .item-row:last-child{border-bottom:none}
    .sub-item-row{padding:.5rem 0 .5rem 1rem;border-left:3px solid #e5e7eb;margin:.3rem 0}
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.375rem;font-size:.75rem;font-weight:700}
    .meter{height:.5rem;background:#e5e7eb;border-radius:.375rem;overflow:hidden}
    .meter-fill{height:100%;background:#2563eb}
    .theoretical-note{background:#f0f9ff;border:1px solid #0ea5e9;color:#0c4a6e;padding:.75rem 1rem;border-radius:.5rem;font-size:.8rem;line-height:1.4}
    .c2-composite{background:#f8fafc;border:1px solid #cbd5e1;border-radius:.5rem;padding:.75rem;margin:.5rem 0}
    .c2-composite-header{background:#e2e8f0;border-bottom:1px solid #cbd5e1;padding:.5rem .75rem;font-weight:600;font-size:.8rem;color:#475569}
    .case-title-input{font-size:1.1rem;font-weight:600;padding:0.75rem 1rem;border:2px solid #3b82f6;border-radius:0.5rem;background:#f8fafc}
    .score-display{background:#f9fafb;border:1px solid #e5e7eb;border-radius:0.5rem;padding:0.75rem;margin-top:0.5rem}
    .score-row{display:flex;justify-content:space-between;align-items:center;padding:0.25rem 0}
    .math-box{background:#fef3c7;border:1px solid #fbbf24;border-radius:0.5rem;padding:0.75rem;margin:0.5rem 0;font-family:monospace;font-size:0.85rem}
    .classification-badge{padding:0.5rem 1rem;border-radius:0.5rem;font-weight:700;font-size:0.9rem;display:inline-block}
    .classification-upgradation{background:#fee2e2;color:#991b1b;border:2px solid #dc2626}
    .classification-marginal{background:#fef3c7;color:#92400e;border:2px solid #f59e0b}
    .classification-modernization{background:#dbeafe;color:#1e40af;border:2px solid #3b82f6}
    .classification-innovation{background:#d1fae5;color:#065f46;border:2px solid #10b981}
    .classification-transformative{background:#e0e7ff;color:#3730a3;border:2px solid #6366f1}
    .classification-revolutionary{background:#fae8ff;color:#6b21a8;border:2px solid #a855f7}

    .evidence-panel{background:#f8fafc;border:1px solid #cbd5e1;border-radius:0.5rem;padding:1rem;margin-top:1rem}
    .evidence-header{font-weight:700;color:#475569;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
    .evidence-result{background:#fff;border:1px solid #e2e8f0;border-radius:0.375rem;padding:0.75rem;margin-bottom:0.5rem}
    .evidence-title{font-weight:600;color:#1e40af;margin-bottom:0.25rem;font-size:0.9rem}
    .evidence-snippet{font-size:0.8rem;color:#475569;line-height:1.4}
    .evidence-url{font-size:0.7rem;color:#64748b;margin-top:0.25rem}
    .search-btn{background:#2563eb;color:#fff;padding:0.5rem 1rem;border-radius:0.375rem;font-size:0.85rem;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .search-btn:hover{background:#1d4ed8}
    .search-btn:disabled{background:#94a3b8;cursor:not-allowed}
    .justification-field{width:100%;padding:0.5rem;border:1px solid #cbd5e1;border-radius:0.375rem;font-size:0.85rem;margin-top:0.5rem;resize:vertical;min-height:60px}
    .warning-badge{background:#fef3c7;color:#92400e;border:1px solid #f59e0b;padding:0.25rem 0.75rem;border-radius:0.375rem;font-size:0.75rem;display:inline-flex;align-items:center;gap:0.25rem}
    .settings-panel{background:#f0f9ff;border:2px solid #0ea5e9;border-radius:0.5rem;padding:1rem;margin-bottom:1rem}
    .settings-input{padding:0.5rem;border:1px solid #cbd5e1;border-radius:0.375rem;font-size:0.85rem;width:100%;max-width:500px;font-family:monospace}
    .search-hint{font-size:0.75rem;color:#6b7280;font-style:italic;margin-top:0.25rem;line-height:1.3}
    .search-example{font-size:0.7rem;color:#3b82f6;margin-top:0.125rem}

    /* Modal styles */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 900px;
      width: 94%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    .modal-h {
      padding: 1rem 1.1rem;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 800;
    }

    .modal-h.bg-blue-50 {
      background: #eff6ff;
      color: #1e40af;
    }

    .modal-h.bg-amber-50 {
      background: #fffbeb;
      color: #92400e;
    }

    .modal-h.bg-red-50 {
      background: #fef2f2;
      color: #991b1b;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root" class="max-w-7xl mx-auto p-6"></div>

  <script type="text/babel">
    const {useState,useMemo,useEffect,useRef} = React;

    /* === Labels and helpers === */
    const LABELS = ["None", "Minimal", "Moderate", "Significant", "Transformative"];
    
    const getLabel = (value) => {
      const rounded = Math.round(value);
      if (rounded < 0) return LABELS[0];
      if (rounded >= LABELS.length) return LABELS[LABELS.length - 1];
      return LABELS[rounded] || LABELS[0];
    };

    const DIMS = [
      { key:"Cognitive",        label:"Cognitive",        def:"Doctrine, training, and mental models change to accommodate the novelty." },
      { key:"Irreversibility",  label:"Irreversibility",  def:"Prior doctrine ceases to be viable as decisive practice; no rational return." },
      { key:"Disruption",       label:"Disruption",       def:"Adversaries are compelled to abandon or radically alter existing methods." },
      { key:"Generative",       label:"Generative",       def:"The change enables new capabilities or follow-on innovations." }
    ];
    const ORDER = DIMS.map(d=>d.key);

    const SUB_KEYS = {
      Cognitive: ["c1","c2","c3","c4"],
      Irreversibility: ["i1","i2","i3","i4"],
      Disruption: ["d1","d2","d3","d4"],
      Generative: ["g1","g2","g3","g4"]
    };

    /* === Search term recommendations per dimension === */
    const SEARCH_TERMS = {
      Cognitive: {
        terms: ["doctrine", "training transformation", "mental models", "TTPs", "operational concepts"],
        example: "doctrine change tactical training"
      },
      Irreversibility: {
        terms: ["path dependence", "sunk costs", "institutional lock-in", "infrastructure investment", "irreversible commitment"],
        example: "path dependence institutional lock-in"
      },
      Disruption: {
        terms: ["OODA loop", "adversary adaptation", "doctrinal breakpoint", "operational paradigm shift", "kill chain"],
        example: "OODA disruption adversary response"
      },
      Generative: {
        terms: ["follow-on capabilities", "spillover effects", "capability families", "cross-domain application", "derivative innovations"],
        example: "follow-on capabilities new systems"
      }
    };

    const mean = arr => {
      const vals = arr.map(v => +v || 0);
      return vals.reduce((a,v)=>a+v,0) / (vals.length || 1);
    };

    /* === Historical dataset (27) === */
    const EXAMPLES = {
      "AI-Targeting": { scores: { Cognitive:1, Irreversibility:1, Disruption:1, Generative:2 }, justification: "AI-targeting speeds up existing processes; limited conceptual change.", sources: ["USAF Mad Scientist Initial Research"] },
      "AIP Submarine": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:2 }, justification: "Extended endurance; new patrol patterns.", sources: ["Polmar & Moore, 2004"] },
      "ASBM": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Conceptual innovation altering naval operational art through integrated OTH radar, SAR satellites, MRBMs, MIRV warheads.", sources: ["Erickson, 2013"] },
      "Barbed Wire": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Offensive assumptions untenable; defensive shift.", sources: ["Bull, 2013"] },
      "Blitzkrieg": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:4 }, justification: "Transformed land warfare; follow-ons; new strategy.", sources: ["Liddell Hart; Guderian"] },
      "Carrier Aviation": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Shift from battleships; aviation embedded.", sources: ["Friedman, 1983"] },
      "Cyber Warfare": { scores: { Cognitive:2, Irreversibility:2, Disruption:2, Generative:3 }, justification: "New domain; integration continues.", sources: ["Libicki, 2012"] },
      "Deep Battle/Reconnaissance Strike Complex": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:3 }, justification: "Operational art entrenched; frontal assaults untenable.", sources: ["Habeck, 2003"] },
      "F-16 Block D": { scores: { Cognitive:0, Irreversibility:1, Disruption:0, Generative:1 }, justification: "Modernization within air superiority paradigm.", sources: ["USAF Fact Sheets"] },
      "Hypersonics": { scores: { Cognitive:1, Irreversibility:1, Disruption:1, Generative:2 }, justification: "Acceleration; limited conceptual shift.", sources: ["Mahnken, 2007"] },
      "Information Warfare": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:4 }, justification: "Digital-age transformation of knowledge conflict.", sources: ["Ricks, 2012"] },
      "Lasers": { scores: { Cognitive:1, Irreversibility:1, Disruption:2, Generative:2 }, justification: "Capability improvement within paradigm.", sources: ["AFRL Primer, 2019"] },
      "Machine Gun": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:3 }, justification: "Linear tactics obsolete; irreversible organization.", sources: ["Ellis, 1975"] },
      "Military Robotics": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:3 }, justification: "Extends human capability; limited reconceptualization.", sources: ["Singer, 2009"] },
      "Minie Ball/Conoidal Bullet": { scores: { Cognitive:3, Irreversibility:3, Disruption:3, Generative:2 }, justification: "Napoleonic tactics untenable; assumptions questioned.", sources: ["Nosworthy, 2003"] },
      "Multi-Domain Battle Concept": { scores: { Cognitive:2, Irreversibility:1, Disruption:2, Generative:3 }, justification: "Challenges stovepipes; embedding incomplete.", sources: ["TRADOC 525-3-1"] },
      "Network-Centric Warfare": { scores: { Cognitive:1, Irreversibility:0, Disruption:1, Generative:2 }, justification: "Theory without institutional/doctrinal embedding; SoS implementations ‚â† NCW.", sources: ["Alberts, Garstka, Stein, 1999"] },
      "Nuclear Weapons": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Complete transformation.", sources: ["Freedman, 2003"] },
      "PGMs": { scores: { Cognitive:1, Irreversibility:2, Disruption:2, Generative:3 }, justification: "Enables new targeting; paradigm intact.", sources: ["Hallion, 1995"] },
      "Radar": { scores: { Cognitive:2, Irreversibility:3, Disruption:3, Generative:3 }, justification: "Transforms air defense; organizational shifts.", sources: ["Fisher, 1988"] },
      "Stealth": { scores: { Cognitive:1, Irreversibility:2, Disruption:2, Generative:2 }, justification: "Improves capabilities within paradigm.", sources: ["Sweetman, 1986"] },
      "Stirrups": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Paradigmatic transformation; feudal structures.", sources: ["Lynn White Jr., 1962"] },
      "Stosstrupp Tactics": { scores: { Cognitive:4, Irreversibility:3, Disruption:4, Generative:3 }, justification: "Infiltration doctrine; linear assaults obsolete.", sources: ["Gudmundsson, 1989"] },
      "T-72B3M Main Battle Tank": { scores: { Cognitive:0, Irreversibility:1, Disruption:0, Generative:1 }, justification: "Upgradation.", sources: ["Bartles, 2015"] },
      "Tank": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Transformed land warfare; org change; new thinking.", sources: ["Harris, 1995"] },
      "Telegraph": { scores: { Cognitive:4, Irreversibility:4, Disruption:4, Generative:4 }, justification: "Courier assumptions untenable; networked command.", sources: ["Hochfelder, 2012"] },
      "UAVs": { scores: { Cognitive:1, Irreversibility:2, Disruption:1, Generative:3 }, justification: "Extends recon/strike; limited paradigm challenge.", sources: ["Singer, 2009"] }
    };

    /* === v1.6 Mathematics - Normalized [0,1] scoring === */
    
    function aggregateC2(c2Scores) {
      return mean([c2Scores.c2a, c2Scores.c2b, c2Scores.c2c, c2Scores.c2d]);
    }

    function computeRawFromSub(subVals){
      return {
        Cognitive:       mean([subVals.c1, aggregateC2(subVals), subVals.c3, subVals.c4]),
        Irreversibility: mean([subVals.i1, subVals.i2, subVals.i3, subVals.i4]),
        Disruption:      mean([subVals.d1, subVals.d2, subVals.d3, subVals.d4]),
        Generative:      mean([subVals.g1, subVals.g2, subVals.g3, subVals.g4])
      };
    }

    function normalizeScores(rawScores) {
      return {
        Cognitive: rawScores.Cognitive / 4,
        Irreversibility: rawScores.Irreversibility / 4,
        Disruption: rawScores.Disruption / 4,
        Generative: rawScores.Generative / 4
      };
    }

    function classify(normScores) {
      const alpha = 0.5, beta = 0.5;
      const C = normScores.Cognitive || 0;
      const I = normScores.Irreversibility || 0;
      const D = normScores.Disruption || 0;
      const G = normScores.Generative || 0;

      const L = Math.min(C / alpha, I / beta);
      
      if (L < 1.0) {
        return {
          classification: "Upgradation",
          L: L,
          I_intensity: undefined,
          reason: "Necessary conditions not met (L < 1.0)"
        };
      }

      const I_intensity = L * Math.sqrt(D * D + G * G);

      let classification;
      if (I_intensity < 0.5) {
        classification = "Marginal Innovation";
      } else if (I_intensity < 1.0) {
        classification = "Modernization";
      } else if (I_intensity < 1.5) {
        classification = "Innovation";
      } else {
        if (C >= 0.75 && I >= 0.75 && D >= 0.75 && G >= 0.75) {
          classification = "Revolutionary Innovation";
        } else {
          classification = "Transformative Innovation";
        }
      }

      return {
        classification: classification,
        L: L,
        I_intensity: I_intensity,
        reason: `L = ${L.toFixed(2)}, I_intensity = ${I_intensity.toFixed(2)}`
      };
    }

    function getClassificationColor(classification) {
      const colors = {
        "Upgradation": "classification-upgradation",
        "Marginal Innovation": "classification-marginal",
        "Modernization": "classification-modernization",
        "Innovation": "classification-innovation",
        "Transformative Innovation": "classification-transformative",
        "Revolutionary Innovation": "classification-revolutionary"
      };
      return colors[classification] || "classification-innovation";
    }

    /* === Validation checks === */
    function computeViolations(subs, normScores, isHistorical){
      if (isHistorical) return {};
      
      const hasUnratedIndicators = Object.entries(subs).some(([key, value]) => {
        if (!key.match(/^[cdgi][1-4]$|^c2[a-d]$/)) return false;
        return value === null || value === undefined || value === '';
      });
      
      return {
        incomplete: hasUnratedIndicators,
        coherence: (normScores.Disruption >= 0.75 || normScores.Generative >= 0.75) && 
                   (normScores.Cognitive < 0.5 || normScores.Irreversibility < 0.5),
        imbalance: Math.max(normScores.Cognitive, normScores.Irreversibility, normScores.Disruption, normScores.Generative) - 
                   Math.min(normScores.Cognitive, normScores.Irreversibility, normScores.Disruption, normScores.Generative) >= 0.5
      };
    }

    const violationMessages = {
      incomplete: "All sub-elements must be rated before analysis.",
      coherence: "High Disruption/Generative but weak Cognitive/Irreversibility suggests disruptive claims without doctrinal change.",
      imbalance: "Extreme imbalance across dimensions (‚â•0.5 spread on normalized scale) suggests uneven manifestation."
    };

    /* === Feedback generation === */
    function generateUserFeedback(subScores, rawScores, normScores, classResult) {
      const feedback = [];

      ORDER.forEach(dim => {
        const d = DIMS.find(x=>x.key===dim);
        const rawVal = rawScores[dim] || 0;
        const normVal = normScores[dim] || 0;
        feedback.push(`**${d.label}**: Raw score ${rawVal.toFixed(2)}/4 (Normalized: ${normVal.toFixed(2)}) - ${getLabel(rawVal)}`);
      });

      feedback.push(`**Innovation Likelihood (L)**: ${classResult.L ? classResult.L.toFixed(2) : 'N/A'}`);
      if (classResult.I_intensity !== undefined) {
        feedback.push(`**Innovation Intensity**: ${classResult.I_intensity.toFixed(2)}`);
      }

      feedback.push(`**Classification**: ${classResult.classification}`);
      feedback.push(`**Reason**: ${classResult.reason}`);

      return feedback;
    }

    function getEducationalAnalysis(caseName, example, classResult) {
      const s = example.scores;
      return [
        `**Historical Case**: ${caseName}`,
        `**Original Scores**: Cognitive:${s.Cognitive}, Irreversibility:${s.Irreversibility}, Disruption:${s.Disruption}, Generative:${s.Generative}`,
        `**Classification (v1.6)**: ${classResult.classification}`,
        `**L (Likelihood)**: ${classResult.L.toFixed(2)}`,
        classResult.I_intensity !== undefined ? `**I_intensity**: ${classResult.I_intensity.toFixed(2)}` : '',
        `**Justification**: ${example.justification}`,
        `**Sources**: ${example.sources.join(', ')}.`
      ].filter(x => x);
    }

    /* === Evidence Search Functions - Google Custom Search === */
    async function searchEvidence(query, apiKey, searchEngineId) {
      if (!apiKey || !searchEngineId) {
        throw new Error('API credentials not configured');
      }

      try {
        const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=5`;
        const response = await fetch(url);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `Search failed: ${response.status}`);
        }

        const data = await response.json();
        
        return (data.items || []).map(item => ({
          title: item.title,
          description: item.snippet,
          url: item.link
        }));
      } catch (error) {
        console.error('Search error:', error);
        throw error;
      }
    }

    function extractKeywords(text) {
      const stopWords = new Set(['the', 'is', 'at', 'which', 'on', 'a', 'an', 'and', 'or', 'but', 'in', 'with', 'to', 'for', 'of', 'as', 'by', 'this', 'that']);
      const words = text.toLowerCase().split(/\W+/).filter(w => w.length > 3 && !stopWords.has(w));
      return [...new Set(words)].slice(0, 5).join(' ');
    }

    /* === Settings Component === */
    function SettingsPanel({apiKey, setApiKey, searchEngineId, setSearchEngineId}) {
      const [localKey, setLocalKey] = useState(apiKey);
      const [localCx, setLocalCx] = useState(searchEngineId);
      const [saved, setSaved] = useState(false);

      useEffect(() => {
        const storedKey = localStorage.getItem('google_api_key');
        const storedCx = localStorage.getItem('google_search_engine_id');
        if (storedKey) {
          setLocalKey(storedKey);
          setApiKey(storedKey);
        }
        if (storedCx) {
          setLocalCx(storedCx);
          setSearchEngineId(storedCx);
        }
      }, []);

      function saveSettings() {
        localStorage.setItem('google_api_key', localKey);
        localStorage.setItem('google_search_engine_id', localCx);
        setApiKey(localKey);
        setSearchEngineId(localCx);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      }

      return (
        <div className="settings-panel">
          <div className="font-semibold mb-2">üîß Search Configuration (Google Custom Search)</div>
          <div className="text-sm text-gray-600 mb-3">
            Using Google Custom Search API. Free tier: 100 searches/day.
          </div>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium mb-1">API Key</label>
              <input
                type="text"
                value={localKey}
                onChange={e => setLocalKey(e.target.value)}
                placeholder="AIza..."
                className="settings-input"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Search Engine ID</label>
              <input
                type="text"
                value={localCx}
                onChange={e => setLocalCx(e.target.value)}
                placeholder="61b572d99cb424a78"
                className="settings-input"
              />
            </div>
            <button onClick={saveSettings} className="search-btn">
              {saved ? '‚úì Saved' : 'Save Settings'}
            </button>
          </div>
        </div>
      );
    }

    /* === Evidence Display Component === */
    function EvidenceResults({results, loading, error}) {
      if (loading) {
        return <div className="evidence-panel"><div className="text-gray-600">üîç Searching evidence...</div></div>;
      }

      if (error) {
        return (
          <div className="evidence-panel">
            <div className="text-red-600">‚ö†Ô∏è Search failed: {error}</div>
            <div className="text-sm text-gray-600 mt-2">Check your API credentials in settings above.</div>
          </div>
        );
      }

      if (!results || results.length === 0) {
        return (
          <div className="evidence-panel">
            <div className="text-gray-600">No results found. Try refining your justification keywords.</div>
          </div>
        );
      }

      return (
        <div className="evidence-panel">
          <div className="evidence-header">
            üìö Evidence Results ({results.length})
          </div>
          {results.map((result, idx) => (
            <div key={idx} className="evidence-result">
              <div className="evidence-title">{result.title}</div>
              <div className="evidence-snippet">{result.description}</div>
              <a href={result.url} target="_blank" rel="noopener noreferrer" className="evidence-url hover:text-blue-600">
                {result.url}
              </a>
            </div>
          ))}
        </div>
      );
    }

    /* === Dimension Evidence Search Component === */
    function DimensionEvidenceSearch({dimension, caseName, apiKey, searchEngineId, onEvidenceSearched, initialJustification=""}) {
      const [justification, setJustification] = useState(initialJustification);
      const [results, setResults] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [searched, setSearched] = useState(false);

      useEffect(() => {
        setJustification(initialJustification);
      }, [initialJustification]);

      async function handleSearch() {
        if (!justification.trim()) {
          setError('Please provide justification text before searching');
          return;
        }

        if (!apiKey || !searchEngineId) {
          setError('API credentials not configured - check settings above');
          return;
        }

        setLoading(true);
        setError(null);
        setSearched(false);

        try {
          const keywords = extractKeywords(justification);
          const dimTerms = SEARCH_TERMS[dimension];
          const query = caseName 
            ? `${caseName} ${dimension} military innovation ${keywords}`
            : `${dimension} military innovation ${keywords}`;
          
          const searchResults = await searchEvidence(query, apiKey, searchEngineId);
          setResults(searchResults);
          setSearched(true);
          if (onEvidenceSearched) onEvidenceSearched(dimension);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }

      const dimTerms = SEARCH_TERMS[dimension];

      return (
        <div className="mt-4 border-t pt-4">
          <div className="font-medium text-sm text-gray-700 mb-2">
            Evidence Search for {dimension}
            {!searched && <span className="warning-badge ml-2">‚ö†Ô∏è Not searched</span>}
          </div>
          <textarea
            value={justification}
            onChange={e => setJustification(e.target.value)}
            placeholder={`Justify your ${dimension} assessment (e.g., "Transforms targeting doctrine through autonomous decision-making")`}
            className="justification-field"
          />
          <div className="search-hint">
            <strong>Recommended search terms:</strong> {dimTerms.terms.join(', ')}
          </div>
          <div className="search-example">
            Example query: "{caseName || 'Your case'} {dimTerms.example}"
          </div>
          <button
            onClick={handleSearch}
            disabled={loading || !justification.trim()}
            className="search-btn mt-2"
          >
            {loading ? 'üîç Searching...' : 'üîç Search Evidence'}
          </button>

          {(results || loading || error) && (
            <EvidenceResults results={results} loading={loading} error={error} />
          )}
        </div>
      );
    }

    /* === Modal === */
    function IssuesModal({issues,meta,subScores,rawScores,normScores,classResult,violations,onClose}){
      if(!issues && !meta) return null;
      const isHistorical = !!(meta && meta.ex && EXAMPLES[meta.label]);
      const isUserInput = !isHistorical && meta && meta.label && Object.values(subScores||{}).some(v => v>0);
      const hasCriteriaViolations = violations && Object.values(violations).some(Boolean);

      let title='Assessment Review', sub='Assessment completed successfully.', content=[];
      
      if (isUserInput && hasCriteriaViolations) {
        title='Assessment Guidance';
        sub = `Analysis of "${meta.label}"`;
        const failedKeys = Object.entries(violations).filter(([_,v])=>v).map(([k])=>k);
        content = failedKeys.map(k => `**${k.charAt(0).toUpperCase() + k.slice(1)}**: ${violationMessages[k]}`);
      } else if (isUserInput) {
        title='Assessment Results';
        sub = `Analysis of "${meta.label}"`;
        content = generateUserFeedback(subScores, rawScores, normScores, classResult);
      } else if (isHistorical) {
        title='Historical Case Analysis';
        sub = `Educational analysis:`;
        content = getEducationalAnalysis(meta.label, meta.ex, classResult);
      } else {
        content = ["Assessment completed successfully."];
      }

      return (
        <div className="modal-bg" onClick={onClose}>
          <div className="modal" onClick={e=>e.stopPropagation()}>
            <div className={`modal-h ${hasCriteriaViolations ? 'bg-amber-50' : 'bg-blue-50'}`}>{title}</div>
            <div className="px-4 pt-2 pb-1 text-sm text-gray-700">{sub}</div>
            <div className="p-4 max-h-[60vh] overflow-auto">
              <ul className="space-y-3">
                {content.map((m,i)=>(
                  <li key={i} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                    <span className="text-blue-600 font-bold text-lg">‚Ä¢</span>
                    <div className="text-sm text-gray-800 leading-relaxed"
                      dangerouslySetInnerHTML={{__html: m.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>')}}/>
                  </li>
                ))}
              </ul>
            </div>
            <div className="p-4 border-t text-right">
              <button onClick={onClose} className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Close</button>
            </div>
          </div>
        </div>
      );
    }

    /* === Sub-indicator schema === */
    const SUBS = {
      Cognitive: [
        {k:"c1", name:"Core Assumptions Challenged", hint:"Prospective vs retrospective change"},
        {k:"c2", name:"Shift in Process Logics/Systems", hint:"Composite of procedures, architecture, interface, skills", composite:true,
          subElements:[
            {k:"c2a",name:"Procedural Integration",hint:"SOP changes?"},
            {k:"c2b",name:"System Architecture",hint:"Infrastructure/API shifts?"},
            {k:"c2c",name:"Human-Machine Interface",hint:"Cognitive workflow shifts?"},
            {k:"c2d",name:"Skill Requirements",hint:"New competencies?"},
          ]
        },
        {k:"c3", name:"Doctrine/PME Revision", hint:"TTPs, manuals, curricula"},
        {k:"c4", name:"New Criteria for Success", hint:"Measures of effectiveness"},
      ],
      Irreversibility: [
        {k:"i1", name:"Training & Skill Path Dependence", hint:"Pipelines"},
        {k:"i2", name:"Logistics & Infrastructure", hint:"Supply/maintenance"},
        {k:"i3", name:"Adversary Compulsion to Mirror", hint:"Rival adoption"},
        {k:"i4", name:"Institutional Lock-in/Force Structure", hint:"Sunk costs"},
      ],
      Disruption: [
        {k:"d1", name:"OODA Disruption", hint:"Observation/decision broken"},
        {k:"d2", name:"Doctrinal Breakpoints", hint:"Old doctrine unusable"},
        {k:"d3", name:"Kill-Chain/Topology Shifts", hint:"Sequencing changes"},
        {k:"d4", name:"Adversary Scramble", hint:"Urgent counters"},
      ],
      Generative: [
        {k:"g1", name:"New Capability Families", hint:"Follow-ons"},
        {k:"g2", name:"Cross-Domain Spillovers", hint:"Transfers"},
        {k:"g3", name:"Organizational Implications", hint:"Formations/schools"},
        {k:"g4", name:"Conceptual Platform", hint:"Base for further development"},
      ]
    };

    /* === Sub-panel component === */
    function SubPanel({dim, values, setValue, locked=false, isHistorical=false, rawScore, normScore, caseName, apiKey, searchEngineId, onEvidenceSearched, evidenceSearched, historicalJustification=""}) {
      const items = SUBS[dim];
      
      const rated = items.filter(it => {
        if (it.composite) {
          return it.subElements.some(subEl => values[subEl.k] > 0);
        }
        return values[it.k] > 0;
      }).length;

      const dMeta = DIMS.find(d=>d.key===dim);

      return (
        <div className="panel">
          <div className="panel-h">
            <div className="flex items-center gap-2">
              <span>{dMeta.label}</span>
              {!evidenceSearched && !isHistorical && (
                <span className="warning-badge text-xs">‚ö†Ô∏è Evidence not reviewed</span>
              )}
            </div>
            <div className="hint">{dMeta.def}</div>
            <div className="text-sm text-gray-600 mt-1">
              {isHistorical ? `Historical case` : `${rated}/4 rated`}
            </div>
            {rawScore !== undefined && (
              <div className="score-display mt-2">
                <div className="score-row">
                  <span className="font-semibold">Raw Score [0-4]:</span>
                  <span>{rawScore.toFixed(2)} ({getLabel(rawScore)})</span>
                </div>
                <div className="score-row">
                  <span className="font-semibold">Normalized [0-1]:</span>
                  <span>{normScore.toFixed(2)}</span>
                </div>
              </div>
            )}
          </div>
          <div className="panel-b">
            {items.map(it=>(
              <div key={it.k} className={it.composite ? "c2-composite" : "item-row"}>
                <div className="flex items-center justify-between">
                  <div className="font-medium text-sm"><span>{it.name}</span></div>
                  <div className="text-xs text-gray-600">
                    {it.composite ? getLabel(aggregateC2(values)) : getLabel(values[it.k]||0)}
                  </div>
                </div>
                <div className="hint">{it.hint}</div>

                {it.composite && it.subElements && (
                  <div className="ml-4 space-y-2 border-l-2 border-gray-200 pl-3 mt-3">
                    <div className="c2-composite-header">
                      C2 Composite Sub-Elements (Average: {getLabel(aggregateC2(values))} - {aggregateC2(values).toFixed(2)}/4)
                    </div>
                    {it.subElements.map(subEl => (
                      <div key={subEl.k} className="sub-item-row">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <label className="block text-xs font-medium text-gray-600">{subEl.name}</label>
                            <div className="text-xs text-gray-500 mt-1">{subEl.hint}</div>
                          </div>
                          <div className="ml-3 text-xs text-gray-600">{getLabel(values[subEl.k]||0)}</div>
                        </div>
                        {locked ? (
                          <>
                            <div className="mt-2 meter"><div className="meter-fill" style={{width: `${((values[subEl.k]||0)/4)*100}%`}}></div></div>
                            <div className="text-[10px] text-gray-500 mt-1">Historical case assessment</div>
                          </>
                        ) : (
                          <div className="mt-3">
                            <input type="range" min="0" max="4" step="1" value={values[subEl.k]||0}
                              onChange={e=> setValue(subEl.k, Number(e.target.value))}
                              className="w-full"/>
                            <div className="flex justify-between text-xs text-gray-500 mt-1">
                              {LABELS.map((label, idx) => (
                                <span key={idx} className={values[subEl.k] === idx ? 'font-bold text-blue-600' : ''}>{label}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {!it.composite && (
                  <>
                    {locked ? (
                      <>
                        <div className="mt-2 meter"><div className="meter-fill" style={{width: `${((values[it.k]||0)/4)*100}%`}}></div></div>
                        <div className="text-[10px] text-gray-500 mt-1">Historical case assessment</div>
                      </>
                    ) : (
                      <div className="mt-3">
                        <input type="range" min="0" max="4" step="1" value={values[it.k]||0}
                          onChange={e=> setValue(it.k, Number(e.target.value))}
                          className="w-full"/>
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          {LABELS.map((label, idx) => (
                            <span key={idx} className={values[it.k] === idx ? 'font-bold text-blue-600' : ''}>{label}</span>
                          ))}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
            ))}

            {!locked && (
              <DimensionEvidenceSearch
                dimension={dim}
                caseName={caseName}
                apiKey={apiKey}
                searchEngineId={searchEngineId}
                onEvidenceSearched={onEvidenceSearched}
                initialJustification={historicalJustification}
              />
            )}
          </div>
        </div>
      );
    }

    /* === Charts === */
    function RadarChart({normScores}) {
      const ref = useRef(null);
      const chart = useRef(null);
      const values = useMemo(() => ORDER.map(k => +(normScores[k] || 0)), [normScores]);

      useEffect(() => {
        const ctx = ref.current.getContext('2d');
        if (chart.current) chart.current.destroy();
        chart.current = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: DIMS.map(d => d.label),
            datasets: [
              {
                label: 'Current Assessment (Normalized [0,1])',
                data: values,
                fill: true,
                backgroundColor: 'rgba(37,99,235,0.2)',
                borderColor: 'rgba(37,99,235,1)',
                borderWidth: 2,
                pointRadius: 4,
                pointBackgroundColor: 'rgba(37,99,235,1)'
              },
              {
                label: 'Necessary Condition Threshold (C‚â•0.5, I‚â•0.5)',
                data: [0.5, 0.5, 0, 0],
                fill: false,
                borderColor: 'rgba(239,68,68,0.8)',
                borderDash: [6, 4],
                borderWidth: 2,
                pointRadius: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.r;
                    return `${label}: ${value.toFixed(2)}`;
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                min: 0,
                max: 1,
                ticks: { 
                  stepSize: 0.25,
                  callback: value => value.toFixed(2)
                },
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
        return () => { if (chart.current) chart.current.destroy(); };
      }, [values]);

      return <div style={{height:"400px"}}><canvas ref={ref}/></div>;
    }

    function BarChart({rawScores}){
      const ref=useRef(null), chart=useRef(null);
      const values = useMemo(()=> ORDER.map(k => +(rawScores[k]||0)), [rawScores]);
      const colorFor=v=> v>=3?'rgba(22,163,74,0.85)':v>=2?'rgba(234,179,8,0.95)':'rgba(239,68,68,0.95)';
      
      useEffect(()=>{
        const ctx=ref.current.getContext('2d');
        if(chart.current) chart.current.destroy();
        chart.current=new Chart(ctx,{
          type:'bar',
          data:{
            labels:DIMS.map(d=>d.label),
            datasets:[{
              label:'Raw Dimension Scores [0-4]',
              data:values,
              backgroundColor:values.map(colorFor),
              borderColor:values.map(colorFor),
              borderWidth: 1
            }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{display:false},
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.y;
                    const qualitative = getLabel(value);
                    return `${qualitative} (${value.toFixed(2)})`;
                  }
                }
              }
            },
            scales:{
              y:{
                beginAtZero:true,
                min:0,
                max:4,
                ticks:{
                  stepSize:1,
                  callback: value => getLabel(value)
                },
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: { grid: { display: false } }
            }
          }
        });
        return ()=> chart.current && chart.current.destroy();
      },[values]);
      return <div style={{height:"400px"}}><canvas ref={ref}/></div>;
    }

    /* === Historical Examples === */
    function HistoricalExamples({setRawScores,setNormScores,setMeta,setSubScores,setClassResult,setIssues,apiKey,searchEngineId}){
      const keys=Object.keys(EXAMPLES);
      const [sel,setSel]=useState("");
      const [subs,setSubs]=useState(null);
      const [evidenceSearched, setEvidenceSearched] = useState({});

      function buildSubFromExample(ex) {
        const s = {};
        const rep=(arr,val)=>arr.forEach(k=>s[k]=val);
        rep(SUB_KEYS.Disruption,      ex.scores.Disruption);
        rep(SUB_KEYS.Irreversibility, ex.scores.Irreversibility);
        rep(SUB_KEYS.Cognitive,       ex.scores.Cognitive);
        rep(SUB_KEYS.Generative,      ex.scores.Generative);
        s.c2a = ex.scores.Cognitive; s.c2b = ex.scores.Cognitive;
        s.c2c = ex.scores.Cognitive; s.c2d = ex.scores.Cognitive;
        return s;
      }

      function evaluateAndRender(nextSubs){
        const raw = computeRawFromSub(nextSubs);
        const norm = normalizeScores(raw);
        const classRes = classify(norm);
        
        setRawScores(raw);
        setNormScores(norm);
        setClassResult(classRes);
        setSubScores(nextSubs);
        
        const ex = EXAMPLES[sel];
        setIssues(getEducationalAnalysis(sel, ex, classRes));
      }

      function setValue(k,v){
        setSubs(prev=>{
          const next = {...prev, [k]: v};
          evaluateAndRender(next);
          return next;
        });
      }

      function loadFromSelection(v){
        setSel(v);
        setEvidenceSearched({});
        if (!v) {
          setRawScores({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0});
          setNormScores({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0});
          setMeta({});
          setSubScores({});
          setClassResult({classification:"Upgradation",L:0,I_intensity:undefined,reason:""});
          setIssues([]);
          return;
        }
        const ex = EXAMPLES[v];
        setMeta({label: v, ex});
        const subVals = buildSubFromExample(ex);
        setSubs(subVals);
        evaluateAndRender(subVals);
      }

      const ex = sel ? EXAMPLES[sel] : null;

      return (
        <div className="space-y-6">
          <div>
            <h2 className="text-2xl font-semibold">Historical Examples</h2>
            <p className="text-sm text-gray-600 mt-1">
              Select a case. All 27 cases assessed using v1.6 mathematics (normalized scoring, L/I_intensity classification).
            </p>
          </div>

          <div className="flex flex-wrap items-center gap-3">
            <label className="text-sm font-medium">Example</label>
            <select value={sel} onChange={e=>loadFromSelection(e.target.value)} className="border rounded-md px-3 py-2 text-sm min-w-[20rem]">
              <option value="">‚Äî choose a case ‚Äî</option>
              {keys.map(k=><option key={k} value={k}>{k}</option>)}
            </select>
          </div>

          {ex && (
            <div className="grid md:grid-cols-2 gap-6">
              {ORDER.map(dim=>{
                const pick = {};
                SUB_KEYS[dim].forEach(key => pick[key] = (subs && key in subs) ? subs[key] : ex.scores[dim]||0);
                if (dim === 'Cognitive') {
                  ['c2a','c2b','c2c','c2d'].forEach(k => pick[k] = (subs && k in subs) ? subs[k] : ex.scores.Cognitive||0);
                }
                const rawScore = computeRawFromSub(subs || buildSubFromExample(ex))[dim];
                const normScore = rawScore / 4;
                return (
                  <SubPanel 
                    key={dim} 
                    dim={dim} 
                    values={pick} 
                    setValue={setValue} 
                    locked={false} 
                    isHistorical={true} 
                    rawScore={rawScore} 
                    normScore={normScore}
                    caseName={sel}
                    apiKey={apiKey}
                    searchEngineId={searchEngineId}
                    onEvidenceSearched={(d) => setEvidenceSearched(prev => ({...prev, [d]: true}))}
                    evidenceSearched={evidenceSearched[dim]}
                    historicalJustification={ex.justification}
                  />
                );
              })}
              <div className="md:col-span-2 panel panel-b text-sm">
                <div className="font-semibold mb-1">Explanation & References</div>
                <div className="text-gray-700 mb-3">{ex.justification}</div>
                {(ex.sources||[]).map((r,i)=>(<div key={i}>‚Ä¢ {r}</div>))}
              </div>
            </div>
          )}
        </div>
      );
    }

    /* === Test Your Idea === */
    function TestYourIdea({setRawScores,setNormScores,setMeta,setSubScores,setClassResult,setIssues,apiKey,searchEngineId}){
      const [label,setLabel]=useState("");
      const [sub,setSub]=useState({
        d1:0,d2:0,d3:0,d4:0,
        i1:0,i2:0,i3:0,i4:0,
        c1:0,c2:0,c3:0,c4:0,c2a:0,c2b:0,c2c:0,c2d:0,
        g1:0,g2:0,g3:0,g4:0
      });
      const [evidenceSearched, setEvidenceSearched] = useState({});

      function runEval(nextSub){
        const raw = computeRawFromSub(nextSub);
        const norm = normalizeScores(raw);
        const classRes = classify(norm);
        
        setRawScores(raw);
        setNormScores(norm);
        setClassResult(classRes);
        setSubScores(nextSub);
        setIssues(generateUserFeedback(nextSub, raw, norm, classRes));
      }

      function setValue(k,v){
        setSub(prev=>{
          const next = {...prev, [k]: v};
          runEval(next);
          return next;
        });
      }

      useEffect(()=>{ setMeta({label}); },[label]);

      return (
        <div className="space-y-6">
          <div className="theoretical-note">
            <div className="font-semibold mb-2">MIAF v1.6 Framework with Evidence Search</div>
            <div className="space-y-1 text-sm">
              <div><strong>Necessary Conditions:</strong> Cognitive ‚â• 0.5 AND Irreversibility ‚â• 0.5 (on normalized scale)</div>
              <div><strong>Assessment Flow:</strong> Sub-elements [0-4] ‚Üí Raw dimensions [0-4] ‚Üí Normalized [0-1] ‚Üí L & I_intensity ‚Üí Classification</div>
              <div><strong>Evidence Search:</strong> Justify dimension scores ‚Üí search for supporting/contradicting evidence ‚Üí refine assessment</div>
              <div><strong>Philosophy:</strong> Innovation requires both cognitive transformation and institutional embedding, validated by evidence</div>
            </div>
          </div>

          <div className="panel panel-b">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 className="text-2xl font-semibold">Test Your Idea</h2>
                <p className="text-sm text-gray-600 mt-2">Score sub-elements [0-4]. Provide justification and search evidence per dimension.</p>
              </div>
              <div className="flex flex-col gap-2">
                <label className="text-sm font-medium text-gray-700">Innovation Concept Title</label>
                <input value={label} onChange={e=>setLabel(e.target.value)}
                       className="case-title-input w-80" 
                       placeholder="e.g., AI-enabled autonomous logistics coordination"/>
                {!label && <div className="text-xs text-blue-600">Enter a descriptive title</div>}
              </div>
            </div>

            <div className="mt-6 grid md:grid-cols-2 gap-6">
              {ORDER.map(dim=>{
                const pick = {};
                SUB_KEYS[dim].forEach(key => pick[key] = sub[key]);
                if (dim === 'Cognitive') ['c2a','c2b','c2c','c2d'].forEach(k => pick[k] = sub[k]);
                const rawScore = computeRawFromSub(sub)[dim];
                const normScore = rawScore / 4;
                return (
                  <SubPanel 
                    key={dim} 
                    dim={dim} 
                    values={pick} 
                    setValue={setValue} 
                    locked={false} 
                    isHistorical={false} 
                    rawScore={rawScore} 
                    normScore={normScore}
                    caseName={label}
                    apiKey={apiKey}
                    searchEngineId={searchEngineId}
                    onEvidenceSearched={(d) => setEvidenceSearched(prev => ({...prev, [d]: true}))}
                    evidenceSearched={evidenceSearched[dim]}
                  />
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    /* === Charts + Status === */
    function ChartsPanel({rawScores,normScores,classResult,meta,subScores,openModal}){
      const isHistorical = !!(meta && meta.ex && EXAMPLES[meta.label]);

      const violations = useMemo(()=>{
        if (!subScores || Object.keys(subScores).length===0) return {};
        return computeViolations(subScores, normScores, isHistorical);
      },[subScores, normScores, isHistorical]);

      const failedKeys = Object.entries(violations).filter(([_,v])=>v).map(([k])=>k);

      return (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="panel">
            <div className="panel-h">Radar Chart (Normalized [0,1])</div>
            <div className="panel-b"><RadarChart normScores={normScores}/></div>
          </div>
          <div className="panel">
            <div className="panel-h">Bar Chart (Raw [0,4])</div>
            <div className="panel-b"><BarChart rawScores={rawScores}/></div>
          </div>

          <div className="md:col-span-2 panel panel-b">
            <div className="flex flex-col gap-4">
              <div className="flex items-center gap-4 flex-wrap">
                <div className={`classification-badge ${getClassificationColor(classResult.classification)}`}>
                  {classResult.classification}
                </div>
                {meta && meta.label && <div className="text-gray-600">Case: <span className="font-medium">{meta.label}</span></div>}
              </div>

              <div className="math-box">
                <div className="font-semibold mb-2">Mathematical Analysis (v1.6)</div>
                <div>L (Innovation Likelihood) = min(C/0.5, I/0.5) = {classResult.L ? classResult.L.toFixed(2) : 'N/A'}</div>
                {classResult.I_intensity !== undefined && (
                  <div>I_intensity = L √ó ‚àö(D¬≤ + G¬≤) = {classResult.I_intensity.toFixed(2)}</div>
                )}
                <div className="mt-2 text-sm">{classResult.reason}</div>
              </div>

              {failedKeys.length>0 && !isHistorical && (
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                  <div className="font-semibold text-amber-900 mb-2">Assessment Guidance</div>
                  {failedKeys.map(k=>(
                    <div key={k} className="text-sm text-amber-800 mb-1">‚Ä¢ {violationMessages[k]}</div>
                  ))}
                </div>
              )}

              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                {DIMS.map(d=>(
                  <div key={d.key}>
                    <div className="font-semibold">{d.label}</div>
                    <div>Raw: {(rawScores[d.key] || 0).toFixed(2)}/4</div>
                    <div>Norm: {(normScores[d.key] || 0).toFixed(2)}</div>
                    <div className="text-gray-600">{getLabel(rawScores[d.key] || 0)}</div>
                  </div>
                ))}
              </div>

              <div className="flex justify-end">
                <button
                  onClick={openModal}
                  className="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">
                  View Detailed Analysis
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    /* === App === */
    function App(){
      const [tab,setTab]=useState('test');
      const [rawScores,setRawScores]=useState({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0});
      const [normScores,setNormScores]=useState({Cognitive:0,Irreversibility:0,Disruption:0,Generative:0});
      const [classResult,setClassResult]=useState({classification:"Upgradation",L:0,I_intensity:undefined,reason:""});
      const [meta,setMeta]=useState({label:""});
      const [subScores,setSubScores]=useState({});
      const [issues,setIssues]=useState([]);
      const [modalOpen,setModalOpen]=useState(false);
      const [apiKey,setApiKey]=useState("AIzaSyBlXjjV8mZy_Smm1TIDBqviv6blbJqNYYM");
      const [searchEngineId,setSearchEngineId]=useState("61b572d99cb424a78");

      const violations = useMemo(()=>{
        if (!subScores || Object.keys(subScores).length===0) return {};
        return computeViolations(subScores, normScores, !!(meta && meta.ex && EXAMPLES[meta.label]));
      },[subScores, normScores, meta]);

      return (
        <main>
          <header className="text-center space-y-1 mb-6">
            <h1 className="text-4xl md:text-5xl font-extrabold text-gray-900">Military Innovation Assessment Framework</h1>
            <h2 className="text-xl md:text-2xl font-bold text-gray-800">v5.1 - Evidence-Informed Assessment</h2>
            <div className="text-md md:text-lg text-gray-700">Normalized Scoring | L & I_intensity Classification | Evidence Search</div>
            <div className="text-xs text-gray-500 mt-1">(c) Manabrata Guha, 2025</div>
          </header>

          <SettingsPanel apiKey={apiKey} setApiKey={setApiKey} searchEngineId={searchEngineId} setSearchEngineId={setSearchEngineId} />

          <div className="big-tabs">
            {[
              {k:'test',label:'Test Your Idea'},
              {k:'examples',label:'Historical Examples (27 Cases)'}
            ].map(t=>(
              <button key={t.k} onClick={()=>setTab(t.k)}
                className={'big-tab ' + (tab===t.k?'big-tab-active':'big-tab-inactive')}>{t.label}</button>
            ))}
          </div>

          <section className="space-y-6">
            {tab==='test' && (
              <>
                <TestYourIdea
                  setRawScores={setRawScores}
                  setNormScores={setNormScores}
                  setMeta={setMeta}
                  setSubScores={setSubScores}
                  setClassResult={setClassResult}
                  setIssues={setIssues}
                  apiKey={apiKey}
                  searchEngineId={searchEngineId}
                />
                <ChartsPanel rawScores={rawScores} normScores={normScores} classResult={classResult} meta={meta} subScores={subScores} openModal={()=>setModalOpen(true)}/>
              </>
            )}
            {tab==='examples' && (
              <>
                <HistoricalExamples
                  setRawScores={setRawScores}
                  setNormScores={setNormScores}
                  setMeta={setMeta}
                  setSubScores={setSubScores}
                  setClassResult={setClassResult}
                  setIssues={setIssues}
                  apiKey={apiKey}
                  searchEngineId={searchEngineId}
                />
                <ChartsPanel rawScores={rawScores} normScores={normScores} classResult={classResult} meta={meta} subScores={subScores} openModal={()=>setModalOpen(true)}/>
              </>
            )}
          </section>

          <footer className="mt-10 text-center text-xs text-gray-500">
            Military Innovation Assessment Framework v5.1 (c) Manabrata Guha, 2025
          </footer>

          {modalOpen && <IssuesModal issues={issues} meta={meta} subScores={subScores} rawScores={rawScores} normScores={normScores} classResult={classResult} violations={violations} onClose={()=>setModalOpen(false)}/>}
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
